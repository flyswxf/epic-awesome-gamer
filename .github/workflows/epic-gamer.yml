name: Epic Awesome Gamer (Scheduled Twice Weekly)

on:
  # 1. æ‰‹åŠ¨è§¦å‘ï¼šæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:

  # 2. å®šæ—¶è§¦å‘ï¼šæ¯å‘¨è¿è¡Œä¸¤æ¬¡
  # æ ¼å¼ï¼šåˆ† æ—¶ å¤© æœˆ å‘¨
  # è¿™é‡Œçš„ '55 15 * * 2,5' è¡¨ç¤ºæ¯å‘¨äºŒã€æ¯å‘¨äº”çš„ UTC 15:55 è¿è¡Œ
  # å¯¹åº”åŒ—äº¬æ—¶é—´çº¦ä¸ºï¼šå‘¨äºŒã€å‘¨äº” 23:55
  schedule:
    - cron: '55 15 * * 2,5'

jobs:
  epic-gamer:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # ç¬¬ä¸€æ­¥ï¼šå®‰å…¨æ£€æŸ¥ï¼ˆå¿…é¡»åœ¨ç§æœ‰ä»“åº“è¿è¡Œï¼‰
      - name: Check repository visibility
        run: |
          if [[ "${{ github.event.repository.private }}" != "true" ]]; then
            echo "âš ï¸ å®‰å…¨è­¦å‘Šï¼šæ­¤ Workflow åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œå¿…é¡»åœ¨ç§æœ‰ä»“åº“ä¸­è¿è¡Œã€‚"
            echo "è¯·å°†ä»“åº“è®¾ç½®ä¸º Private åå†è¯•ã€‚"
            exit 1
          fi

      # ç¬¬äºŒæ­¥ï¼šæ£€å‡ºä½ ä¿®æ”¹åçš„ä»£ç ï¼ˆåŒ…å« AiHubMix æ‹¦æˆªå™¨ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4

      # ç¬¬ä¸‰æ­¥ï¼šå®‰è£… uv åŒ…ç®¡ç†å·¥å…·
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      # ç¬¬å››æ­¥ï¼šè®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        run: uv python install 3.12

      # ç¬¬äº”æ­¥ï¼šå®‰è£…ç³»ç»Ÿè¿è¡Œç¯å¢ƒ
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libxml2-dev libxslt-dev

      # ç¬¬å…­æ­¥ï¼šåŒæ­¥ä¾èµ–ï¼ˆå®‰è£… openai ç­‰æ–°å¢åº“ï¼‰
      - name: Install dependencies
        run: uv sync

      # ç¬¬ä¸ƒæ­¥ï¼šä¸‹è½½æµè§ˆå™¨å†…æ ¸
      - name: Install Camoufox
        run: uv run camoufox fetch

      # ç¬¬å…«æ­¥ï¼šæ‰§è¡Œä»»åŠ¡ï¼ˆä¼ é€’æ‰€æœ‰ AiHubMix å’Œ Epic å¯†é’¥ï¼‰
      - name: Run Epic Awesome Gamer
        env:
          EPIC_EMAIL: ${{ secrets.EPIC_EMAIL }}
          EPIC_PASSWORD: ${{ secrets.EPIC_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_BASE_URL: ${{ secrets.GEMINI_BASE_URL }}
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}
          ENABLE_APSCHEDULER: false
        run: |
          echo "ğŸš€ å¯åŠ¨å®šæ—¶é¢†å–ä»»åŠ¡ï¼ˆå·²é€‚é… AiHubMix ä¸­è½¬ï¼‰..."
          xvfb-run --auto-servernum --server-num=1 --server-args='-screen 0, 1920x1080x24' uv run app/deploy.py
